# agg() å‡½æ•°å›¾è§£è¯´æ˜

## ğŸ¯ æ ¸å¿ƒæ¦‚å¿µï¼šä¸‰æ­¥èµ°

```
åŸå§‹æ•°æ® â†’ åˆ†ç»„(groupby) â†’ èšåˆ(agg) â†’ ç»“æœ
```

---

## ğŸ“Š ç¤ºä¾‹1ï¼šç†è§£åˆ†ç»„å’Œèšåˆçš„åŸºæœ¬è¿‡ç¨‹

### åŸå§‹æ•°æ®è¡¨

```
äº§å“    åœ°åŒº    ä»·æ ¼    æ•°é‡
è‹¹æœ    åŒ—äº¬    5.0    100
è‹¹æœ    ä¸Šæµ·    6.0    200
é¦™è•‰    åŒ—äº¬    3.0     80
é¦™è•‰    ä¸Šæµ·    3.5    120
æ©™å­    åŒ—äº¬    4.0     90
æ©™å­    ä¸Šæµ·    4.2    130
```

### ç¬¬ä¸€æ­¥ï¼šæŒ‰"äº§å“"åˆ†ç»„ (groupby)

```python
grouped = df.groupby('product')
```

åˆ†ç»„åçš„æ•ˆæœï¼ˆåœ¨å†…å­˜ä¸­çš„é€»è¾‘åˆ†ç»„ï¼‰ï¼š

```
ç»„1: è‹¹æœ
    äº§å“    åœ°åŒº    ä»·æ ¼    æ•°é‡
    è‹¹æœ    åŒ—äº¬    5.0    100
    è‹¹æœ    ä¸Šæµ·    6.0    200
    
ç»„2: é¦™è•‰
    äº§å“    åœ°åŒº    ä»·æ ¼    æ•°é‡
    é¦™è•‰    åŒ—äº¬    3.0     80
    é¦™è•‰    ä¸Šæµ·    3.5    120
    
ç»„3: æ©™å­
    äº§å“    åœ°åŒº    ä»·æ ¼    æ•°é‡
    æ©™å­    åŒ—äº¬    4.0     90
    æ©™å­    ä¸Šæµ·    4.2    130
```

### ç¬¬äºŒæ­¥ï¼šå¯¹æ¯ç»„åº”ç”¨èšåˆå‡½æ•° (agg)

```python
result = grouped['price'].agg('mean')
```

è®¡ç®—è¿‡ç¨‹ï¼š

```
ç»„1 (è‹¹æœ): (5.0 + 6.0) / 2 = 5.5
ç»„2 (é¦™è•‰): (3.0 + 3.5) / 2 = 3.25
ç»„3 (æ©™å­): (4.0 + 4.2) / 2 = 4.1
```

### ç¬¬ä¸‰æ­¥ï¼šå¾—åˆ°ç»“æœ

```
äº§å“    price_mean
è‹¹æœ    5.5
é¦™è•‰    3.25
æ©™å­    4.1
```

---

## ğŸ“Š ç¤ºä¾‹2ï¼šå•åˆ—å¤šä¸ªå‡½æ•°

### ä»£ç 

```python
df.groupby('product')['price'].agg(['mean', 'min', 'max'])
```

### å¤„ç†è¿‡ç¨‹å›¾è§£

```
åŸå§‹æ•°æ®:
äº§å“    ä»·æ ¼
è‹¹æœ    5.0  â”€â”€â”
è‹¹æœ    6.0  â”€â”€â”¤â†’ åˆ†ç»„1: [5.0, 6.0] â†’ mean=5.5, min=5.0, max=6.0
               â”‚
é¦™è•‰    3.0  â”€â”€â”¤
é¦™è•‰    3.5  â”€â”€â”¤â†’ åˆ†ç»„2: [3.0, 3.5] â†’ mean=3.25, min=3.0, max=3.5
               â”‚
æ©™å­    4.0  â”€â”€â”¤
æ©™å­    4.2  â”€â”€â”˜â†’ åˆ†ç»„3: [4.0, 4.2] â†’ mean=4.1, min=4.0, max=4.2
```

### ç»“æœè¡¨

```
äº§å“    mean    min     max
è‹¹æœ    5.5     5.0     6.0
é¦™è•‰    3.25    3.0     3.5
æ©™å­    4.1     4.0     4.2
```

---

## ğŸ“Š ç¤ºä¾‹3ï¼šå¤šåˆ—ä¸åŒå‡½æ•°ï¼ˆæœ€å¼ºå¤§ï¼ï¼‰

### ä»£ç 

```python
df.groupby('product').agg({
    'price': ['mean', 'std'],      # ä»·æ ¼ï¼šå‡å€¼å’Œæ ‡å‡†å·®
    'quantity': ['sum', 'count']   # æ•°é‡ï¼šæ€»å’Œå’Œè®¡æ•°
})
```

### å¤„ç†è¿‡ç¨‹å›¾è§£

```
              â”Œâ”€ price: mean, std
æŒ‰äº§å“åˆ†ç»„ â”€â”€â”€â”€â”¤
              â””â”€ quantity: sum, count

ç»„1: è‹¹æœ
  price: [5.0, 6.0]     â†’ mean=5.5, std=0.71
  quantity: [100, 200]  â†’ sum=300, count=2

ç»„2: é¦™è•‰
  price: [3.0, 3.5]     â†’ mean=3.25, std=0.35
  quantity: [80, 120]   â†’ sum=200, count=2

ç»„3: æ©™å­
  price: [4.0, 4.2]     â†’ mean=4.1, std=0.14
  quantity: [90, 130]   â†’ sum=220, count=2
```

### ç»“æœè¡¨ï¼ˆå¤šå±‚åˆ—åï¼‰

```
          price           quantity
          mean    std     sum      count
äº§å“
è‹¹æœ      5.5     0.71    300      2
é¦™è•‰      3.25    0.35    200      2
æ©™å­      4.1     0.14    220      2
```

---

## ğŸ“Š ç¤ºä¾‹4ï¼šå®é™…åº”ç”¨ - TWAPç­–ç•¥ä¸­çš„ç”¨æ³•

### åœºæ™¯ï¼šè®¢å•è–„æ•°æ®æŒ‰10åˆ†é’ŸåŒºé—´åˆ†ç»„

åŸå§‹æ•°æ®ï¼ˆæ¯3ç§’ä¸€ä¸ªsnapshotï¼‰ï¼š

```
æ—¶é—´        åŒºé—´ID   åŒºé—´æ ‡ç­¾        ä»·æ ¼     ä»·å·®    ç´¯ç§¯æˆäº¤é‡
10:00:00    60      10:00-10:10    100.0    0.02    1000
10:00:03    60      10:00-10:10    100.5    0.03    1050
10:00:06    60      10:00-10:10    101.0    0.02    1100
10:10:00    61      10:10-10:20    101.5    0.03    1150
10:10:03    61      10:10-10:20    102.0    0.04    1200
10:10:06    61      10:10-10:20    101.8    0.03    1250
```

### ä»£ç 

```python
stats = df.groupby(['interval_id', 'interval_label']).agg({
    'mid_price': ['mean', 'min', 'max'],   # ä»·æ ¼ç»Ÿè®¡
    'spread': ['mean', 'std'],              # ä»·å·®ç»Ÿè®¡
    'amount': ['first', 'last']             # åŒºé—´é¦–å°¾æˆäº¤é‡
})
```

### åˆ†ç»„å¤„ç†è¿‡ç¨‹

```
ç»„1: interval_id=60 (10:00-10:10)
  â”œâ”€ mid_price: [100.0, 100.5, 101.0]
  â”‚    â†’ mean = 100.5
  â”‚    â†’ min = 100.0
  â”‚    â†’ max = 101.0
  â”œâ”€ spread: [0.02, 0.03, 0.02]
  â”‚    â†’ mean = 0.023
  â”‚    â†’ std = 0.006
  â””â”€ amount: [1000, 1050, 1100]
       â†’ first = 1000 (åŒºé—´å¼€å§‹)
       â†’ last = 1100 (åŒºé—´ç»“æŸ)

ç»„2: interval_id=61 (10:10-10:20)
  â”œâ”€ mid_price: [101.5, 102.0, 101.8]
  â”‚    â†’ mean = 101.77
  â”‚    â†’ min = 101.5
  â”‚    â†’ max = 102.0
  â”œâ”€ spread: [0.03, 0.04, 0.03]
  â”‚    â†’ mean = 0.033
  â”‚    â†’ std = 0.006
  â””â”€ amount: [1150, 1200, 1250]
       â†’ first = 1150
       â†’ last = 1250
```

### æœ€ç»ˆç»“æœ

```
interval_id  interval_label  mid_price_mean  mid_price_min  mid_price_max  spread_mean  amount_first  amount_last
60          10:00-10:10      100.5          100.0          101.0          0.023        1000          1100
61          10:10-10:20      101.77         101.5          102.0          0.033        1150          1250
```

### ä¸ºä»€ä¹ˆè¦ç”¨ first å’Œ lastï¼Ÿ

```
å› ä¸º amount æ˜¯ç´¯ç§¯æˆäº¤é‡ï¼š

åŒºé—´æˆäº¤é‡ = amount_last - amount_first
         = 1100 - 1000 = 100  (10:00-10:10è¿™10åˆ†é’Ÿå†…æ–°å¢çš„æˆäº¤é‡)
```

---

## ğŸ” agg() å­—å…¸è¯­æ³•è¯¦è§£

```python
df.groupby('category').agg({
    'åˆ—å1': 'å•ä¸ªå‡½æ•°',
    'åˆ—å2': ['å‡½æ•°1', 'å‡½æ•°2', 'å‡½æ•°3'],
    'åˆ—å3': ['å‡½æ•°A', 'å‡½æ•°B']
})
```

### æ ¼å¼è¯´æ˜

```python
{
    'åˆ—å': å‡½æ•°       # â† è¿™æ˜¯é”®å€¼å¯¹
}
```

- **é”®ï¼ˆKeyï¼‰**ï¼šåˆ—åï¼ˆå­—ç¬¦ä¸²ï¼‰
- **å€¼ï¼ˆValueï¼‰**ï¼šå‡½æ•°åï¼ˆå­—ç¬¦ä¸²ï¼‰æˆ–å‡½æ•°åˆ—è¡¨

### ç¤ºä¾‹å¯¹æ¯”

```python
# âŒ é”™è¯¯ï¼šæ²¡æœ‰æŒ‡å®šåˆ—å
df.groupby('product').agg(['mean', 'sum'])

# âœ… æ­£ç¡®ï¼šæŒ‡å®šå¯¹å“ªäº›åˆ—åº”ç”¨å“ªäº›å‡½æ•°
df.groupby('product').agg({
    'price': ['mean', 'std'],
    'quantity': ['sum', 'count']
})
```

---

## ğŸ“ ç†è§£è¦ç‚¹

### 1. ä¸ºä»€ä¹ˆå«"èšåˆ"ï¼ˆaggregateï¼‰ï¼Ÿ

å› ä¸ºå®ƒæŠŠå¤šè¡Œæ•°æ®"èšåˆ"æˆä¸€è¡Œï¼š

```
å¤šè¡Œ â†’ ä¸€è¡Œ

è‹¹æœ  5.0  â”
è‹¹æœ  6.0  â”¤ èšåˆ â†’ è‹¹æœ  5.5 (å¹³å‡å€¼)
è‹¹æœ  5.5  â”˜
```

### 2. åˆ†ç»„çš„æœ¬è´¨

æƒ³è±¡ä½ æœ‰ä¸€å †å¡ç‰‡ï¼š

```
åŸå§‹ï¼š[è‹¹æœå¡ç‰‡] [é¦™è•‰å¡ç‰‡] [è‹¹æœå¡ç‰‡] [æ©™å­å¡ç‰‡] [é¦™è•‰å¡ç‰‡] [è‹¹æœå¡ç‰‡]

æŒ‰äº§å“åˆ†ç»„ï¼š
  è‹¹æœçš„å †ï¼š[è‹¹æœ] [è‹¹æœ] [è‹¹æœ]
  é¦™è•‰çš„å †ï¼š[é¦™è•‰] [é¦™è•‰]
  æ©™å­çš„å †ï¼š[æ©™å­]

ç„¶åå¯¹æ¯å †åˆ†åˆ«è®¡ç®—ç»Ÿè®¡å€¼
```

### 3. agg() vs ç›´æ¥è°ƒç”¨å‡½æ•°

```python
# æ–¹å¼1ï¼šç›´æ¥è°ƒç”¨
df.groupby('product')['price'].mean()

# æ–¹å¼2ï¼šç”¨agg
df.groupby('product')['price'].agg('mean')

# ä¸¤è€…ç­‰ä»·ï¼Œä½†aggæ›´çµæ´»ï¼Œå¯ä»¥ä¸€æ¬¡åº”ç”¨å¤šä¸ªå‡½æ•°
df.groupby('product')['price'].agg(['mean', 'std', 'min', 'max'])
```

---

## ğŸ’¡ å¸¸è§ç”¨æ³•é€ŸæŸ¥

### 1. å•åˆ—å•å‡½æ•°
```python
df.groupby('A')['B'].agg('mean')
# æˆ–
df.groupby('A')['B'].mean()
```

### 2. å•åˆ—å¤šå‡½æ•°
```python
df.groupby('A')['B'].agg(['mean', 'std', 'min', 'max'])
```

### 3. æ‰€æœ‰æ•°å€¼åˆ—åº”ç”¨åŒæ ·çš„å‡½æ•°
```python
df.groupby('A').agg(['mean', 'sum'])
```

### 4. ä¸åŒåˆ—ä¸åŒå‡½æ•°ï¼ˆæœ€å¸¸ç”¨ï¼‰
```python
df.groupby('A').agg({
    'B': 'mean',
    'C': ['sum', 'count'],
    'D': ['min', 'max', 'std']
})
```

### 5. è‡ªå®šä¹‰å‡½æ•°
```python
def my_range(x):
    return x.max() - x.min()

df.groupby('A')['B'].agg([my_range, 'mean'])
```

---

## ğŸ”§ å¤„ç†å¤šå±‚åˆ—å

agg() äº§ç”Ÿå¤šå±‚åˆ—åæ—¶ï¼Œå¯ä»¥è¿™æ ·å¤„ç†ï¼š

```python
# èšåˆ
result = df.groupby('product').agg({
    'price': ['mean', 'std'],
    'quantity': 'sum'
})

# åˆ—åæ˜¯å¤šå±‚çš„ï¼š('price', 'mean'), ('price', 'std'), ('quantity', 'sum')
print(result.columns)

# æ‰å¹³åŒ–åˆ—å
result.columns = ['_'.join(col).strip('_') for col in result.columns]

# ç°åœ¨åˆ—åå˜æˆï¼š'price_mean', 'price_std', 'quantity_sum'
print(result.columns)
```

---

## ğŸ“ ç»ƒä¹ å»ºè®®

1. è¿è¡Œ `agg_detailed_tutorial.py`ï¼Œçœ‹æ¯ä¸ªä¾‹å­çš„è¾“å‡º
2. å°è¯•ä¿®æ”¹å‡½æ•°åˆ—è¡¨ï¼Œçœ‹ç»“æœå¦‚ä½•å˜åŒ–
3. ç”¨è‡ªå·±çš„æ•°æ®å°è¯•ä¸åŒçš„èšåˆæ–¹å¼
4. ç†è§£"åˆ†ç»„â†’èšåˆâ†’åˆå¹¶"çš„ä¸‰æ­¥æµç¨‹

---

## ğŸ¯ è®°å¿†å£è¯€

```
aggæ˜¯èšåˆï¼Œå¤šå˜ä¸€
åˆ†ç»„ä¹‹åç”¨å®ƒå¥½
ä¸€åˆ—å¤šå‡½æ•°ï¼Œå¤šåˆ—å„ä¸åŒ
å­—å…¸è¯­æ³•æœ€çµæ´»
```

**æ ¸å¿ƒå…¬å¼**ï¼š
```
ç»“æœ = åŸæ•°æ®.groupby(åˆ†ç»„åˆ—).agg({
    åˆ—1: [å‡½æ•°A, å‡½æ•°B],
    åˆ—2: [å‡½æ•°C, å‡½æ•°D]
})
```


