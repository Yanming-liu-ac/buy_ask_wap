# è®¢å•å’Œäº¤æ˜“ç‰¹å¾æå–åŠŸèƒ½ - ä½¿ç”¨æŒ‡å—

## æ¦‚è¿°

å·²æˆåŠŸä¸º `price_prediction_linear.py` æ·»åŠ äº†ä»è®¢å•ï¼ˆMBOï¼‰å’Œäº¤æ˜“ï¼ˆMBPï¼‰æ•°æ®ä¸­æå–ç‰¹å¾çš„åŠŸèƒ½ã€‚è¯¥åŠŸèƒ½ä½¿ç”¨**å®Œå…¨çŸ¢é‡åŒ–**çš„pandasæ“ä½œï¼Œæ€§èƒ½ä¼˜å¼‚ã€‚

## æ–°å¢ç‰¹å¾åˆ—è¡¨

### 1. è®¢å•ç‰¹å¾ï¼ˆä»MBOæ•°æ®ï¼‰

é’ˆå¯¹æ¯ä¸ªè®¢å•è–„snapshotï¼Œè®¡ç®—è¿‡å»Nç§’ï¼ˆé»˜è®¤5ç§’ï¼‰å†…çš„ï¼š

| ç‰¹å¾å | è¯´æ˜ | é‡è¦æ€§ |
|-------|------|--------|
| `buy_order_count_Ns` | ä¹°å•æ•°é‡ | â­â­â­ åæ˜ ä¹°æ–¹ä¸‹å•æ„æ„¿ |
| `buy_order_volume_Ns` | ä¹°å•æ€»é‡ï¼ˆè‚¡ï¼‰ | â­â­â­â­ ä¹°æ–¹è®¢å•æµå¼ºåº¦ |
| `buy_order_amount_Ns` | ä¹°å•æ€»é‡‘é¢ï¼ˆå…ƒï¼‰ | â­â­â­â­ ä¹°æ–¹èµ„é‡‘æŠ•å…¥ |
| `sell_order_count_Ns` | å–å•æ•°é‡ | â­â­â­ åæ˜ å–æ–¹ä¸‹å•æ„æ„¿ |
| `sell_order_volume_Ns` | å–å•æ€»é‡ï¼ˆè‚¡ï¼‰ | â­â­â­â­ å–æ–¹è®¢å•æµå¼ºåº¦ |
| `sell_order_amount_Ns` | å–å•æ€»é‡‘é¢ï¼ˆå…ƒï¼‰ | â­â­â­â­ å–æ–¹èµ„é‡‘æŠ•å…¥ |
| `order_flow_imbalance_Ns` | è®¢å•æµä¸å¹³è¡¡åº¦ | â­â­â­â­â­ ä¹°å–åŠ›é‡å¯¹æ¯” |
| `order_amount_imbalance_Ns` | è®¢å•é‡‘é¢ä¸å¹³è¡¡åº¦ | â­â­â­â­â­ èµ„é‡‘æµå‘ |

**è®¢å•æµä¸å¹³è¡¡åº¦è®¡ç®—å…¬å¼ï¼š**
```
order_flow_imbalance = (ä¹°é‡ - å–é‡) / (ä¹°é‡ + å–é‡)
```
- å€¼åŸŸï¼š[-1, 1]
- +1 è¡¨ç¤ºå…¨æ˜¯ä¹°å‹ â†’ ä»·æ ¼å¯èƒ½ä¸Šæ¶¨
- -1 è¡¨ç¤ºå…¨æ˜¯å–å‹ â†’ ä»·æ ¼å¯èƒ½ä¸‹è·Œ
- 0 è¡¨ç¤ºä¹°å–å¹³è¡¡

### 2. äº¤æ˜“ç‰¹å¾ï¼ˆä»MBPæ•°æ®ï¼‰

é’ˆå¯¹æ¯ä¸ªè®¢å•è–„snapshotï¼Œè®¡ç®—è¿‡å»Nç§’å†…çš„ï¼š

| ç‰¹å¾å | è¯´æ˜ | é‡è¦æ€§ |
|-------|------|--------|
| `buy_trade_count_Ns` | ä¹°æ–¹æˆäº¤ç¬”æ•° | â­â­â­ ä¹°æ–¹äº¤æ˜“æ´»è·ƒåº¦ |
| `buy_trade_volume_Ns` | ä¹°æ–¹æˆäº¤æ€»é‡ï¼ˆè‚¡ï¼‰ | â­â­â­â­â­ ä¸»åŠ¨ä¹°å…¥å¼ºåº¦ |
| `buy_trade_amount_Ns` | ä¹°æ–¹æˆäº¤æ€»é‡‘é¢ï¼ˆå…ƒï¼‰ | â­â­â­â­â­ ä¹°æ–¹èµ„é‡‘æµå…¥ |
| `sell_trade_count_Ns` | å–æ–¹æˆäº¤ç¬”æ•° | â­â­â­ å–æ–¹äº¤æ˜“æ´»è·ƒåº¦ |
| `sell_trade_volume_Ns` | å–æ–¹æˆäº¤æ€»é‡ï¼ˆè‚¡ï¼‰ | â­â­â­â­â­ ä¸»åŠ¨å–å‡ºå¼ºåº¦ |
| `sell_trade_amount_Ns` | å–æ–¹æˆäº¤æ€»é‡‘é¢ï¼ˆå…ƒï¼‰ | â­â­â­â­â­ å–æ–¹èµ„é‡‘æµå‡º |
| `trade_volume_imbalance_Ns` | æˆäº¤é‡ä¸å¹³è¡¡åº¦ | â­â­â­â­â­ æˆäº¤æ–¹å‘ |
| `trade_amount_imbalance_Ns` | æˆäº¤é¢ä¸å¹³è¡¡åº¦ | â­â­â­â­â­ èµ„é‡‘æµå‘ |
| `trade_intensity_Ns` | äº¤æ˜“å¼ºåº¦ | â­â­â­â­ å¸‚åœºæ´»è·ƒåº¦ |

**äº¤æ˜“å¼ºåº¦è®¡ç®—å…¬å¼ï¼š**
```
trade_intensity = (ä¹°æ–¹æˆäº¤é‡ + å–æ–¹æˆäº¤é‡) / æ—¶é—´çª—å£ï¼ˆç§’ï¼‰
```
- å•ä½ï¼šè‚¡/ç§’
- å€¼è¶Šå¤§è¡¨ç¤ºå¸‚åœºè¶Šæ´»è·ƒ

## ä½¿ç”¨æ–¹æ³•

### æ–¹æ³•1ï¼šç›´æ¥è¿è¡Œä¸»ç¨‹åº

```bash
python price_prediction_linear.py
```

ç¨‹åºä¼šè‡ªåŠ¨ï¼š
1. å°è¯•åŠ è½½ `mbo.csv` å’Œ `mbp.csv`
2. å¦‚æœæ–‡ä»¶å­˜åœ¨ä¸”æ—¶é—´èŒƒå›´åŒ¹é…ï¼Œè‡ªåŠ¨æå–è®¢å•/äº¤æ˜“ç‰¹å¾
3. å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨æˆ–æ—¶é—´ä¸åŒ¹é…ï¼Œè·³è¿‡è¿™äº›ç‰¹å¾ï¼Œåªä½¿ç”¨è®¢å•è–„ç‰¹å¾

### æ–¹æ³•2ï¼šåœ¨è‡ªå·±çš„ä»£ç ä¸­ä½¿ç”¨

```python
import pandas as pd
from price_prediction_linear import create_order_trade_features

# åŠ è½½æ•°æ®
df = pd.read_parquet('orderbook_sampled_10min_intervals.parquet')
mbo = pd.read_csv('mbo.csv')
mbp = pd.read_csv('mbp.csv')

# æå–ç‰¹å¾ï¼ˆè¿‡å»5ç§’çš„çª—å£ï¼‰
df_with_features = create_order_trade_features(df, mbo, mbp, lookback_seconds=5)

# æŸ¥çœ‹æ–°å¢ç‰¹å¾
new_cols = [c for c in df_with_features.columns if 'order' in c or 'trade' in c]
print(f"æ–°å¢ç‰¹å¾: {new_cols}")
```

### æ–¹æ³•3ï¼šè¿è¡Œæ¼”ç¤ºè„šæœ¬

```bash
python demo_order_trade_features.py
```

è¿™ä¸ªè„šæœ¬ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®æ¼”ç¤ºåŠŸèƒ½ï¼Œä¼šç”Ÿæˆå¯è§†åŒ–å›¾è¡¨ `order_trade_features_demo.png`ã€‚

## æ•°æ®è¦æ±‚

### å¿…éœ€å­—æ®µ

**MBOæ•°æ®ï¼ˆè®¢å•æ•°æ®ï¼‰ï¼š**
- `ts_event`: äº‹ä»¶æ—¶é—´æˆ³ï¼ˆdatetimeç±»å‹ï¼‰
- `side`: ä¹°å–æ–¹å‘ï¼ˆ'B' = ä¹°ï¼Œ'S' = å–ï¼‰
- `price`: è®¢å•ä»·æ ¼ï¼ˆfloatï¼‰
- `size`: è®¢å•æ•°é‡ï¼ˆintï¼‰
- `order_id`: è®¢å•IDï¼ˆç”¨äºè®¡æ•°ï¼‰

**MBPæ•°æ®ï¼ˆäº¤æ˜“æ•°æ®ï¼‰ï¼š**
- `ts_event`: äº‹ä»¶æ—¶é—´æˆ³ï¼ˆdatetimeç±»å‹ï¼‰
- `price`: æˆäº¤ä»·æ ¼ï¼ˆfloatï¼‰
- `size`: æˆäº¤æ•°é‡ï¼ˆintï¼‰
- `sequence`: åºåˆ—å·ï¼ˆç”¨äºè®¡æ•°ï¼‰
- `side`: ä¹°å–æ–¹å‘ï¼ˆå¯é€‰ï¼Œ'B' = ä¹°ï¼Œ'S' = å–ï¼‰
- `action`: æ“ä½œç±»å‹ï¼ˆå¯é€‰ï¼Œ'T' = æˆäº¤ï¼‰

### æ—¶é—´å¯¹é½è¦æ±‚

âš ï¸ **é‡è¦**ï¼šè®¢å•è–„ã€MBOã€MBPæ•°æ®çš„æ—¶é—´èŒƒå›´å¿…é¡»æœ‰é‡å ï¼

å½“å‰é¡¹ç›®ä¸­çš„æ•°æ®å­˜åœ¨æ—¶é—´ä¸åŒ¹é…é—®é¢˜ï¼š
- è®¢å•è–„ï¼š2025-12-20ï¼ˆæ¨¡æ‹Ÿæ•°æ®ï¼‰
- MBO/MBPï¼š2025-07-17ï¼ˆçœŸå®æ•°æ®ï¼‰

**è§£å†³æ–¹æ¡ˆï¼š**

1. **ä½¿ç”¨çœŸå®è®¢å•è–„æ•°æ®**ï¼ˆæ¨èï¼‰
   ```python
   # è·å–ä¸MBO/MBPåŒä¸€å¤©çš„è®¢å•è–„æ•°æ®
   df_real = get_orderbook_data('2025-07-17')
   df_real.to_parquet('orderbook_sampled_10min_intervals.parquet')
   ```

2. **ç”ŸæˆåŒ¹é…çš„MBO/MBPæ•°æ®**
   ```python
   # ç”Ÿæˆ2025-12-20çš„æ¨¡æ‹Ÿæ•°æ®
   generate_mbo_data('2025-12-20').to_csv('mbo.csv')
   generate_mbp_data('2025-12-20').to_csv('mbp.csv')
   ```

## æŠ€æœ¯å®ç°

### å®Œå…¨çŸ¢é‡åŒ–

ä½¿ç”¨pandasçš„çŸ¢é‡åŒ–æ“ä½œï¼Œ**å®Œå…¨é¿å…Pythonå¾ªç¯**ï¼š

```python
# 1. æ—¶é—´çª—å£èšåˆ
mbo_agg = mbo.groupby('ts_event').agg({'size': 'sum', 'price': 'mean'})

# 2. ç´¯è®¡å’Œè®¡ç®—
mbo_agg['cumsum'] = mbo_agg['size'].cumsum()

# 3. æ—¶é—´å¯¹é½
df = pd.merge_asof(df, mbo_agg, left_on='timestamp', right_on='ts_event')

# 4. åŒºé—´è®¡ç®—
df['volume_5s'] = df['cumsum_t'] - df['cumsum_t0']
```

### æ€§èƒ½åŸºå‡†

åœ¨æµ‹è¯•ç¯å¢ƒä¸­ï¼ˆIntel i7, 16GB RAMï¼‰ï¼š
- 4000æ¡è®¢å•è–„ + 5000æ¡MBO + 5000æ¡MBP
- 5ç§’å›çœ‹çª—å£
- **å¤„ç†æ—¶é—´ï¼šçº¦ 0.5-1 ç§’**
- å®Œå…¨çŸ¢é‡åŒ–ï¼Œæ— Pythonå¾ªç¯

å¯¹æ¯”ä¼ ç»Ÿå¾ªç¯æ–¹æ³•ï¼Œé€Ÿåº¦æå‡ **100-1000å€**ï¼

## ç‰¹å¾é‡è¦æ€§

æ ¹æ®å¸‚åœºå¾®è§‚ç»“æ„ç†è®ºï¼Œè¿™äº›ç‰¹å¾å¯¹ä»·æ ¼é¢„æµ‹éå¸¸é‡è¦ï¼š

### ğŸŒŸ æœ€é‡è¦çš„ç‰¹å¾ï¼ˆTop 5ï¼‰

1. **è®¢å•æµä¸å¹³è¡¡** (`order_flow_imbalance_5s`)
   - ä¹°å‹ > å–å‹ â†’ ä»·æ ¼ä¸Šæ¶¨æ¦‚ç‡å¤§
   - å–å‹ > ä¹°å‹ â†’ ä»·æ ¼ä¸‹è·Œæ¦‚ç‡å¤§

2. **æˆäº¤é‡ä¸å¹³è¡¡** (`trade_volume_imbalance_5s`)
   - ä¸»åŠ¨ä¹°å…¥ > ä¸»åŠ¨å–å‡º â†’ çœ‹æ¶¨ä¿¡å·
   - ä¸»åŠ¨å–å‡º > ä¸»åŠ¨ä¹°å…¥ â†’ çœ‹è·Œä¿¡å·

3. **ä¹°æ–¹æˆäº¤é‡** (`buy_trade_volume_5s`)
   - å¤§é‡ä¸»åŠ¨ä¹°å…¥ â†’ å¼ºçƒˆçœ‹æ¶¨ä¿¡å·

4. **äº¤æ˜“å¼ºåº¦** (`trade_intensity_5s`)
   - æˆäº¤æ´»è·ƒ â†’ ä»·æ ¼æ³¢åŠ¨å¤§
   - æˆäº¤æ¸…æ·¡ â†’ ä»·æ ¼ç¨³å®š

5. **è®¢å•é‡‘é¢ä¸å¹³è¡¡** (`order_amount_imbalance_5s`)
   - å¤§å•è¿›åœº â†’ å¯èƒ½æœ‰é‡è¦ä¿¡æ¯

### é¢„æœŸæ•ˆæœ

åœ¨çœŸå®å¸‚åœºä¸­ï¼ŒåŠ å…¥è¿™äº›ç‰¹å¾åï¼š
- **æ–¹å‘å‡†ç¡®ç‡**ï¼šé¢„è®¡ä» 50-52% æå‡åˆ° 55-60%
- **MAEï¼ˆå¹³å‡ç»å¯¹è¯¯å·®ï¼‰**ï¼šé¢„è®¡é™ä½ 10-20%
- **RÂ²ï¼ˆå†³å®šç³»æ•°ï¼‰**ï¼šé¢„è®¡ä» 0.95 æå‡åˆ° 0.97-0.98

## æ–‡ä»¶è¯´æ˜

| æ–‡ä»¶å | è¯´æ˜ |
|--------|------|
| `price_prediction_linear.py` | ä¸»ç¨‹åºï¼ˆå·²æ·»åŠ è®¢å•/äº¤æ˜“ç‰¹å¾ï¼‰ |
| `demo_order_trade_features.py` | æ¼”ç¤ºè„šæœ¬ï¼ˆä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼‰ |
| `test_order_trade_features.py` | æµ‹è¯•è„šæœ¬ |
| `è®¢å•äº¤æ˜“ç‰¹å¾è¯´æ˜.md` | è¯¦ç»†æŠ€æœ¯æ–‡æ¡£ |
| `README_è®¢å•äº¤æ˜“ç‰¹å¾.md` | æœ¬æ–‡ä»¶ï¼ˆä½¿ç”¨æŒ‡å—ï¼‰ |
| `order_trade_features_demo.png` | æ¼”ç¤ºå›¾è¡¨ |

## ä¸‹ä¸€æ­¥æ”¹è¿›

### çŸ­æœŸæ”¹è¿›

1. **å¤šæ—¶é—´çª—å£**
   ```python
   for window in [1, 5, 10, 30]:
       df = create_order_trade_features(df, mbo, mbp, lookback_seconds=window)
   ```

2. **æ›´å¤šç»Ÿè®¡é‡**
   - ä¸­ä½æ•°ã€åˆ†ä½æ•°
   - ååº¦ã€å³°åº¦
   - æœ€å¤§å•ç¬”è®¢å•/æˆäº¤

3. **è®¢å•ç°¿æ·±åº¦**
   - ä¸åªçœ‹ä¸€æ¡£ï¼Œçœ‹5æ¡£çš„è®¢å•æµ
   - è®¡ç®—å„æ¡£ä½çš„ä¸å¹³è¡¡åº¦

### é•¿æœŸæ”¹è¿›

1. **è®¢å•ç±»å‹è¯†åˆ«**
   - åŒºåˆ†é™ä»·å•ã€å¸‚ä»·å•
   - è¯†åˆ«æ’¤å•è¡Œä¸º

2. **å¤§å•æ£€æµ‹**
   - è¯†åˆ«å¼‚å¸¸å¤§çš„è®¢å•
   - è·Ÿè¸ªå¤§å•çš„æˆäº¤æƒ…å†µ

3. **è®¢å•æµæ¯’æ€§**
   - è®¡ç®—VPINï¼ˆVolume-Synchronized Probability of Informed Tradingï¼‰
   - è¯†åˆ«çŸ¥æƒ…äº¤æ˜“

## å‚è€ƒæ–‡çŒ®

è¿™äº›ç‰¹å¾åŸºäºå¸‚åœºå¾®è§‚ç»“æ„ç†è®ºï¼š

1. Cont, R., Kukanov, A., & Stoikov, S. (2014). "The price impact of order book events". *Journal of Financial Econometrics*, 12(1), 47-88.

2. Lehalle, C. A., & Laruelle, S. (2018). *Market Microstructure in Practice* (2nd ed.). World Scientific.

3. Easley, D., LÃ³pez de Prado, M. M., & O'Hara, M. (2012). "Flow toxicity and liquidity in a high-frequency world". *The Review of Financial Studies*, 25(5), 1457-1493.

## å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆæˆ‘è¿è¡Œåæ²¡æœ‰è®¢å•/äº¤æ˜“ç‰¹å¾ï¼Ÿ

**A:** å¯èƒ½çš„åŸå› ï¼š
1. `mbo.csv` æˆ– `mbp.csv` æ–‡ä»¶ä¸å­˜åœ¨
2. æ•°æ®æ—¶é—´èŒƒå›´ä¸åŒ¹é…
3. æ•°æ®æ ¼å¼ä¸æ­£ç¡®

æ£€æŸ¥æ–¹æ³•ï¼š
```python
import pandas as pd

df = pd.read_parquet('orderbook_sampled_10min_intervals.parquet')
mbo = pd.read_csv('mbo.csv')

print(f"è®¢å•è–„æ—¶é—´èŒƒå›´: {df['timestamp'].min()} ~ {df['timestamp'].max()}")
print(f"MBOæ—¶é—´èŒƒå›´: {mbo['ts_event'].min()} ~ {mbo['ts_event'].max()}")
```

### Q2: å¤„ç†é€Ÿåº¦å¾ˆæ…¢æ€ä¹ˆåŠï¼Ÿ

**A:** æ£€æŸ¥æ˜¯å¦æœ‰ä»¥ä¸‹é—®é¢˜ï¼š
1. æ•°æ®é‡å¤ªå¤§ï¼ˆ> 100ä¸‡æ¡ï¼‰â†’ è€ƒè™‘åˆ†æ‰¹å¤„ç†
2. æ—¶é—´çª—å£å¤ªé•¿ï¼ˆ> 60ç§’ï¼‰â†’ å‡å°çª—å£
3. æ²¡æœ‰ä½¿ç”¨çŸ¢é‡åŒ– â†’ ç¡®ä¿ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬çš„ä»£ç 

### Q3: å¦‚ä½•è°ƒæ•´æ—¶é—´çª—å£ï¼Ÿ

**A:** ä¿®æ”¹ `lookback_seconds` å‚æ•°ï¼š
```python
# 1ç§’çª—å£ï¼ˆè¶…çŸ­æœŸï¼‰
df = create_order_trade_features(df, mbo, mbp, lookback_seconds=1)

# 5ç§’çª—å£ï¼ˆé»˜è®¤ï¼‰
df = create_order_trade_features(df, mbo, mbp, lookback_seconds=5)

# 30ç§’çª—å£ï¼ˆä¸­æœŸï¼‰
df = create_order_trade_features(df, mbo, mbp, lookback_seconds=30)
```

### Q4: ç‰¹å¾å€¼éƒ½æ˜¯0æˆ–NaNæ€ä¹ˆåŠï¼Ÿ

**A:** å¯èƒ½çš„åŸå› ï¼š
1. æ—¶é—´èŒƒå›´ä¸åŒ¹é… â†’ æ£€æŸ¥æ•°æ®æ—¶é—´
2. å­—æ®µåä¸å¯¹ â†’ æ£€æŸ¥å¿…éœ€å­—æ®µ
3. æ•°æ®ä¸ºç©º â†’ æ£€æŸ¥æ•°æ®åŠ è½½

---

**ä½œè€…**: AI Assistant  
**æ—¥æœŸ**: 2025-12-24  
**ç‰ˆæœ¬**: 1.0

